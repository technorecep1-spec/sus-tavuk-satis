<%- include('partials/header') %>

<div class="main-content">
    <h1>Siparişlerim</h1>
    
    <% if (siparisler && siparisler.length > 0) { %>
        <%# Her bir siparişi kendi kartı içinde gösterelim %>
        <% siparisler.forEach(siparis => { %>
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <div>
                        <strong>Sipariş Tarihi:</strong> <%= new Date(siparis.createdAt).toLocaleDateString('tr-TR') %>
                        <span class="text-muted mx-2">|</span>
                        <strong>Tutar:</strong> <%= formatPrice(siparis.total) %>
                    </div>
                    <div>
                        <strong>Durum:</strong> 
                        <%# Sipariş durumuna göre farklı renklerde etiketler gösterelim %>
                        <% if (siparis.status === 'Teslim Edildi') { %>
                            <span class="badge bg-success"><%= siparis.status %></span>
                        <% } else if (siparis.status === 'Kargolandı') { %>
                            <span class="badge bg-primary"><%= siparis.status %></span>
                        <% } else if (siparis.status === 'Reddedildi') { %>
                            <span class="badge bg-danger"><%= siparis.status %></span>
                        <% } else { %>
                            <span class="badge bg-warning text-dark"><%= siparis.status %></span>
                        <% } %>
                    </div>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <%# Siparişteki her bir ürün için bir liste elemanı %>
                        <% siparis.products.forEach(item => { %>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <%= item.product ? item.product.isim : 'Ürün bilgisi yok' %> 
                                    <span class="text-muted">(x<%= item.quantity %>)</span>
                                </div>
                                
                                <%# --- YORUM YAPMA MANTIĞI BURADA --- %>
                                <% if (siparis.status === 'Teslim Edildi') { %>
                                    <%# Bu ürün daha önce yorumlanmış mı diye kontrol ediyoruz %>
                                    <% const hasReviewed = userReviews.some(review => review.product.toString() === item.product._id.toString()); %>
                                    
                                    <% if (hasReviewed) { %>
                                        <span class="text-success small">
                                            <i class="bi bi-check-circle-fill"></i> Değerlendirildi
                                        </span>
                                    <% } else { %>
                                        <a href="/leave-review/<%= item.product._id %>" class="btn btn-outline-primary btn-sm">
                                            Yorum Yap
                                        </a>
                                    <% } %>
                                <% } %>
                                <%# --- YORUM YAPMA MANTIĞI BİTİŞ --- %>
                            </li>
                        <% }); %>
                    </ul>
                    
                    <!-- Sipariş Detayı Butonu -->
                    <div class="text-center mt-3">
                        <a href="/order-detail/<%= siparis._id %>" class="btn btn-outline-info">
                            <i class="bi bi-eye"></i>
                            Sipariş Detayını Görüntüle
                        </a>
                    </div>
                </div>
            </div>
        <% }); %>
    <% } else { %>
        <div class="alert alert-info">Henüz hiç sipariş vermediniz.</div>
    <% } %>
</div>

<%- include('partials/footer') %>